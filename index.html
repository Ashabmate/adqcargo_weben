<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Daqiq Cargo — Multi-Calculator</title>
  <meta name="description" content="Al Daqiq Cargo Calculator: Express and Container shipping with multi-item calculation." />
  <style>
    :root{
      --bg:#0f172a;            /* slate-900 */
      --card:#111827;          /* gray-900 */
      --muted:#94a3b8;         /* slate-400 */
      --text:#e5e7eb;          /* gray-200 */
      --accent:#22c55e;        /* green-500 */
      --accent-2:#10b981;      /* emerald-500 */
      --danger:#f87171;        /* red-400 */
      --warn:#f59e0b;          /* amber-500 */
      --ring:#334155;          /* slate-700 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 100% -10%, #0b1023 30%, var(--bg) 70%);
      color:var(--text);
    }
    .wrap{max-width:1080px; margin:0 auto; padding:24px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      margin-bottom:20px;
    }
    .brand{display:flex; align-items:center; gap:14px}
    .logo{
      width:54px; height:54px; border-radius:15px;
      object-fit: contain;
    }
    h1{font-size:clamp(22px, 2.6vw, 34px); margin:0}
    .tag{color:var(--muted); font-size:14px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid; grid-template-columns:1fr; gap:24px}
    
    @media(min-width:820px){ 
      .grid{ 
        grid-template-columns: 1fr 1fr; 
        gap: 32px;
      } 
    }

    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    select, input[type="number"], input[type="text"]{
      width:100%; padding:12px 14px; border-radius:12px; background:#0b1224; color:var(--text);
      border:1px solid var(--ring); outline:none; transition:border-color .2s, box-shadow .2s;
    }
    select:focus, input:focus{ border-color: var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.15); }
    /* Styles for disabled inputs */
    input:disabled {
        background: rgba(255,255,255,0.05);
        color: var(--muted);
        border-color: transparent;
        cursor: not-allowed;
    }

    .row-2{display:grid; grid-template-columns:repeat(2, 1fr); gap:12px}

    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hint{font-size:12px; color:var(--muted)}

    /* Tab Styles */
    .tabs {
      display: flex;
      background: #0b1224;
      padding: 4px;
      border-radius: 14px;
      border: 1px solid var(--ring);
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      transition: all 0.2s ease;
      background: transparent;
      border: none;
    }
    .tab-btn.active {
      background: var(--ring);
      color: var(--text);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .tab-btn:hover:not(.active) {
      color: var(--text);
    }

    /* Dynamic Box Row Styles */
    .box-list {
        display: grid;
        gap: 10px;
        margin-top: 10px;
    }
    
    /* Updated Grid: Added columns for checkbox and volume */
    .box-grid-template {
        display: grid;
        /* # | Weight | L | W | H | Check | Volume */
        grid-template-columns: 25px 1.2fr 0.9fr 0.9fr 0.9fr 30px 1.1fr;
        gap: 6px;
        align-items: center;
    }

    .box-row {
        background: rgba(255,255,255,0.03);
        padding: 8px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.05);
    }
    
    .box-num {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        font-weight: bold;
    }
    
    .box-header-row {
        padding: 0 8px;
        margin-bottom: 4px;
    }
    .box-header-col {
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        text-align: center;
        white-space: nowrap;
    }
    .box-row input[type="number"] {
        padding: 8px 4px;
        font-size: 13px;
        text-align: center;
    }
    
    /* Custom Checkbox for Volume Mode */
    .vol-check-wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .vol-check {
        cursor: pointer;
        width: 16px; 
        height: 16px;
        accent-color: var(--accent);
    }

    /* Summary Block */
    .breakdown{background:#0b1224; border:1px dashed var(--ring); border-radius:14px; padding:14px}
    .breakdown .item{display:flex; justify-content:space-between; align-items:center; padding:6px 2px; font-size:14px}
    .breakdown .item strong{font-weight:600}
    .line{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent); margin:8px 0}

    .total{display:flex; align-items:baseline; gap:10px; margin-top:8px}
    .total .big{
      font-size:32px; 
      font-weight:800;
      transition: color .3s ease, transform .1s ease;
      color: var(--text);
    }
    .total .big.highlight {
      color: var(--accent);
      transform: scale(1.03);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 16px; border-radius:12px; background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#04130a; font-weight:700; text-decoration:none; border:0; cursor:pointer;
      box-shadow:0 10px 20px rgba(16,185,129,.25);
      transition: transform .1s ease-in-out, background .2s, opacity .2s, box-shadow .2s;
    }
    .btn:hover:not(:disabled) {
       transform: translateY(-2px);
       filter: brightness(1.1);
       box-shadow:0 12px 25px rgba(16,185,129,.35);
    }
    .btn:active{ transform: translateY(1px) }
    .btn.secondary{ background:#0b1224; color:var(--text); box-shadow:none; border:1px solid var(--ring) }
    .btn.secondary:hover:not(:disabled) {
      background: var(--ring);
      filter: none;
      box-shadow: none;
    }

    .note{background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.3); color:#f8e3b0; padding:12px 14px; border-radius:12px; font-size:13px}
    .danger{background:rgba(248,113,113,.09); border-color:rgba(248,113,113,.38); color:#fecaca}

    footer{margin-top:24px; color:var(--muted); font-size:13px}
    .kicker{font-size:13px; color:var(--muted)}
    .caps{letter-spacing:.08em; text-transform:uppercase; font-size:12px; color:#9ca3af}

    .brandmark{font-weight:800; background: linear-gradient(90deg, #e5e7eb, #a7f3d0); -webkit-background-clip:text; background-clip:text; color:transparent}
    .copy{font-size:12px; color:var(--muted); margin-left:12px}
    .faq-body{margin-top:8px; color:var(--muted); font-size:14px; line-height:1.55}
    
    details.accordion{background:#0b1224; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; transition: border-color .2s, box-shadow .2s;}
    details.accordion summary{cursor:pointer; list-style:none; font-weight:600; color:var(--text)}
    details.accordion summary::after{content:'+'; float:right; color:var(--muted)}
    details.accordion[open] summary::after{content:'–'}
    details.accordion[open]{border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.08)}
    details.accordion:hover:not([open]){
      border-color: var(--accent-2);
    }

    .widget {
      background: #0b1224;
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .widget:last-child {
      margin-bottom: 0;
    }
    .widget-title {
      text-transform: uppercase;
      font-size: 12px;
      color: #9ca3af;
      letter-spacing: .08em;
      margin-bottom: 14px;
      display: block;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="logo.png" alt="Al Daqiq Cargo" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>Al Daqiq Cargo — Calculator</h1>
          <div class="tag">Estimate shipping cost and book your slot</div>
        </div>
      </div>
      <div class="kicker"><span class="caps">UAE</span> • Rates in USD • Preliminary Calculation</div>
    </header>

    <main class="card">
      <div class="grid">
        <section>
          
          <div class="tabs">
            <button type="button" class="tab-btn active" data-mode="express">EXPRESS</button>
            <button type="button" class="tab-btn" data-mode="container">CONTAINER</button>
          </div>

          <div class="widget">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px">
              <span class="widget-title" style="margin-bottom:0">Shipment Details</span>
              <button class="btn secondary" id="resetBtn" type="button" style="padding: 8px 12px; font-size: 13px;">Reset</button>
            </div>

            <div id="productTypeRow" class="row-2" style="margin-bottom:12px; grid-template-columns: 1fr;">
              <div>
                <label for="item">Product Type</label>
                <select id="item" aria-label="Product Type"></select>
              </div>
            </div>

            <div style="margin-bottom:12px">
                 <label for="boxCount">Number of Pieces (Boxes / Pallets)</label>
                 <input id="boxCount" type="number" min="1" step="1" value="1">
            </div>

            <div>
                <div class="box-header-row box-grid-template">
                    <div>#</div>
                    <div class="box-header-col">Weight (kg)</div>
                    <div class="box-header-col">L (cm)</div>
                    <div class="box-header-col">W (cm)</div>
                    <div class="box-header-col">H (cm)</div>
                    <div class="box-header-col" title="Enter volume manually">Man.</div>
                    <div class="box-header-col">Volume (m³)</div>
                </div>
                <div id="boxesContainer" class="box-list">
                    </div>
            </div>

          </div>
          
          <div class="widget">
            <span class="widget-title">Frequently Asked Questions</span>
            <div class="faq" style="margin-top:0"> 
              <details class="accordion">
                <summary>How to enter volume manually?</summary>
                <div class="faq-body">
                    Check the box in the <strong>"Man."</strong> column. The Length, Width, and Height fields will be disabled, and you can enter the exact volume in m³ manually.
                </div>
              </details>
              <details class="accordion" style="margin-top:8px">
                <summary>What is Express?</summary>
                <div class="faq-body">The Express line is a direct air freight. Transit time is 2–3 days. The rate depends on the commodity. Charged based on the greater of the two weights (Volumetric vs. Gross).</div>
              </details>
              <details class="accordion" style="margin-top:8px">
                <summary>How is Container calculated?</summary>
                <div class="faq-body">
                  For container shipping, the weight-to-volume ratio (density) is critical.<br/>
                  — If density is <strong>less than 167 kg/m³</strong>: calculated at $550 per 1 CBM (cubic meter).<br/>
                  — If density is <strong>higher</strong>: rate per kg ($3.5 – $2.0) depending on cargo density.
                </div>
              </details>
            </div>
          </div>
        </section>


        <section>
          <div class="caps" style="margin-bottom:8px">Calculation Summary</div>
          
          <div class="breakdown">
            
            <div class="item"><span>Total Pieces</span><strong id="outQty">—</strong></div>
            <div class="item"><span>Total Gross Weight</span><strong id="outPhysical">—</strong></div>
            <div class="item"><span>Total Volume (CBM)</span><strong id="outCBM">—</strong></div>
            <div class="item"><span>Total Volumetric Weight (Express)</span><strong id="outVolWeight">—</strong></div>
            
            <div id="expressDetails">
                <div class="item"><span>Chargeable Weight for Freight</span><strong id="outChargeable">—</strong></div>
                <div class="line"></div>
                <div class="item"><span>Product Tariff</span><strong id="outRate">—</strong></div>
                <div class="item"><span>Freight $4.5 × Chargeable Weight</span><strong id="outFreight">—</strong></div>
                <div class="item"><span id="residualLabel">Residual Tariff × Gross Weight</span><strong id="outTariffPart">—</strong></div>
                <div class="item"><span>Admin Fee (Fixed)</span><strong id="outAdmin">$ 20.00</strong></div>
            </div>

            <div id="containerDetails" class="hidden">
                <div class="line"></div>
                <div class="item"><span>Total Density (kg/m³)</span><strong id="outDensity">—</strong></div>
                <div class="item"><span>Applied Rate</span><strong id="outContainerRate">—</strong></div>
                <div class="item"><span class="muted small">Condition:</span><strong id="outCondition" class="small muted" style="font-weight:normal; text-align:right; max-width:60%">—</strong></div>
            </div>

            <div class="line"></div>
            <div class="total">
              <div class="muted">Total Payable</div>
              <div class="big" id="outTotal">—</div>
            </div>
          </div>

          <div id="minNote" class="note" style="display:none; margin-top:12px"></div>

          <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:14px">
            <a id="waBtn" class="btn" href="#" target="_blank" rel="noopener">Contact on WhatsApp and Book</a>
            <button id="copyBtn" class="btn secondary" type="button">Copy Calculation</button>
          </div>

          <div class="small muted" style="margin-top:10px">
            By clicking on WhatsApp, you will send the manager an auto-message with the final amount and details.
          </div>
        </section>
      </div>

      <footer>
        <div class="line" style="margin:18px 0"></div>
        <div style="display:grid; gap:8px">
          <div>⚑ Notes:</div>
          <ul id="footerNotes" class="small muted" style="margin:0; padding-left:18px; display:grid; gap:6px">
            </ul>
      </footer>
    </main>

    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:14px">
      <div class="brandmark">Al Daqiq Cargo</div>
      <div class="copy">© <span id="year"></span> — All Rights Reserved</div>
    </div>
  </div>

  <script>
    // === DATA ===

    const TARIFFS = [
      ["Auto Parts", 12], ["Batteries", 35], ["Audio Systems (not ELI)", 25], ["Power Supply", 25], ["Used Auto Parts", 16],
      ["Garmin Fishfinders (not ELI)", 30], ["Dyson Hair Dryers (not ELI)", 25], ["Complete Engines (incl. used)", 18],
      ["Phone Displays", 25], ["Watch Parts", 40], ["Boat and Ship Parts", 12],
      ["Heavy Machinery Parts", 12], ["Game Discs", 20], ["Internet Networking Equipment", 40],
      ["IT Equipment", 40], ["Camera and Video Equipment (not ELI)", 25], ["Printer Cartridges", 16],
      ["Memory Cards SSD, HDD, RAM", 30], ["Keyboard, Mouse (not Apple)", 25], ["Books", 15],
      ["Concert Equipment", 30], ["Cosmetics (not DG)", 35], ["Crypto Wallets and Flash Drives", 40], ["Lamps and Luminaires", 18],
      ["Industrial Lasers", 25], ["Razor Blades", 20], ["Boat Motors", 15], ["Motherboard", 25],
      ["Medical Equipment", 35], ["Mini-PCs (Mains Powered)", 40], ["Microphone Cable", 25],
      ["Monitors", 20], ["Lenses", 40], ["Disposable Cameras", 22], ["Clothing", 20],
      ["Oscilloscope", 30], ["Omnipods", 25], ["Glasses with Cameras (ELI)", 40], ["Parachute Equipment", 18], ["Consoles and Gamepads", 20],["Processors", 40],
      ["Empty Watch Boxes", 20], ["Pens and Stationery", 25], ["Networking Equipment", 30],
      ["Synthetic Oils (not DG)", 20], ["Sunglasses", 25], ["Sports Goods", 20],
      ["Bags", 25], ["Fabrics", 20], ["Televisions", 20], ["Smartphone Cases", 20], ["Sewing Accessories", 18],
      ["Light Meter (Exposure Meter)", 40], ["Action Cameras (GoPro)", 40], ["Electronics", 20],
    ];

    const EX_BASE = 4.5;
    const EX_ADMIN = 20;
    const EX_MIN_W = 30;
    const DIM_DIVISOR = 6000; // for express volumetric weight from cm

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    
    const els = {
      tabs:         $$('.tab-btn'),
      productRow:   $('#productTypeRow'),
      item:         $('#item'),
      boxCount:     $('#boxCount'),
      boxesContainer: $('#boxesContainer'),
      
      // General Outputs
      outQty:         $('#outQty'),
      outPhysical:    $('#outPhysical'),
      outCBM:         $('#outCBM'),
      outVolWeight:   $('#outVolWeight'),
      
      // Blocks
      expressBlock:   $('#expressDetails'),
      containerBlock: $('#containerDetails'),
      
      // Express Fields
      outChargeable:  $('#outChargeable'),
      outRate:        $('#outRate'),
      outFreight:     $('#outFreight'),
      residualLabel:  $('#residualLabel'),
      outTariffPart:  $('#outTariffPart'),
      outAdmin:       $('#outAdmin'),
      
      // Container Fields
      outDensity:     $('#outDensity'),
      outContainerRate:$('#outContainerRate'),
      outCondition:   $('#outCondition'),

      // Overall
      outTotal:       $('#outTotal'),
      minNote:        $('#minNote'),
      footerNotes:    $('#footerNotes'),
      waBtn:          $('#waBtn'),
      copyBtn:        $('#copyBtn'),
      resetBtn:       $('#resetBtn'),
    };

    let MODE = 'express';

    // === BOX LIST MANAGEMENT ===

    function createBoxRow(index) {
        const row = document.createElement('div');
        row.className = 'box-row box-grid-template';
        row.dataset.idx = index;
        
        // Create HTML structure
        row.innerHTML = `
            <div class="box-num">${index}</div>
            <input type="number" class="b-w" placeholder="Weight" min="0" step="0.1">
            <input type="number" class="b-len dim" placeholder="L" min="0" step="1">
            <input type="number" class="b-wid dim" placeholder="W" min="0" step="1">
            <input type="number" class="b-hei dim" placeholder="H" min="0" step="1">
            <div class="vol-check-wrap" title="Enter volume manually">
                <input type="checkbox" class="vol-check">
            </div>
            <input type="number" class="b-vol" placeholder="m³" min="0" step="0.001" disabled>
        `;

        // Event Listeners for this row
        const wInp = row.querySelector('.b-w');
        const dims = row.querySelectorAll('.dim');
        const check = row.querySelector('.vol-check');
        const volInp = row.querySelector('.b-vol');

        // Recalculate on weight input
        wInp.addEventListener('input', recalc);

        // Recalculate on dimension input
        dims.forEach(inp => {
            inp.addEventListener('input', () => {
                if(!check.checked) {
                    calcRowVolumeFromDims(row);
                }
                recalc();
            });
        });

        // Recalculate on manual volume input
        volInp.addEventListener('input', recalc);

        // Mode Switching (Checkbox)
        check.addEventListener('change', () => {
            const isManual = check.checked;
            
            // Toggle availability
            dims.forEach(d => d.disabled = isManual);
            volInp.disabled = !isManual;

            if (isManual) {
                // If manual mode enabled, focus on volume
                volInp.focus();
            } else {
                // If manual mode disabled, recalculate volume from dimensions (even if empty -> 0)
                calcRowVolumeFromDims(row);
            }
            recalc();
        });

        return row;
    }

    // Helper: Calculates volume from LWH fields and writes to volume field
    function calcRowVolumeFromDims(row) {
        const l = parseFloat(row.querySelector('.b-len').value) || 0;
        const w = parseFloat(row.querySelector('.b-wid').value) || 0;
        const h = parseFloat(row.querySelector('.b-hei').value) || 0;
        const volInp = row.querySelector('.b-vol');

        const cm3 = l * w * h;
        const m3 = cm3 / 1000000;
        
        // If dimensions exist, write the result. If zeros - clear the field for display clarity
        if (m3 > 0) {
            volInp.value = Number(m3.toFixed(3)); // rounding for display
        } else {
            volInp.value = '';
        }
    }

    function updateBoxRows() {
        const count = parseInt(els.boxCount.value) || 1;
        const container = els.boxesContainer;
        const currentRows = container.children;
        const currentCount = currentRows.length;

        if (count > currentCount) {
            // Add new rows
            for (let i = currentCount + 1; i <= count; i++) {
                container.appendChild(createBoxRow(i));
            }
        } else if (count < currentCount) {
            // Remove extra rows from the end
            while (container.children.length > count) {
                container.removeChild(container.lastChild);
            }
        }
        recalc();
    }

    // === INITIALIZATION ===

    function initSelect(){
      TARIFFS.forEach(([label, rate], idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = label;
        opt.dataset.rate = rate;
        els.item.appendChild(opt);
      });
    }

    function switchMode(newMode) {
      MODE = newMode;
      els.tabs.forEach(btn => {
        if(btn.dataset.mode === MODE) btn.classList.add('active');
        else btn.classList.remove('active');
      });

      if (MODE === 'express') {
        els.productRow.classList.remove('hidden');
        els.expressBlock.classList.remove('hidden');
        els.containerBlock.classList.add('hidden');
        els.outVolWeight.parentElement.classList.remove('hidden'); 
      } else {
        els.productRow.classList.add('hidden');
        els.expressBlock.classList.add('hidden');
        els.containerBlock.classList.remove('hidden');
        els.outVolWeight.parentElement.classList.add('hidden');
      }

      updateNotes();
      recalc();
    }

    function updateNotes() {
        if (MODE === 'express') {
            els.footerNotes.innerHTML = `
            <li>Calculation: <strong>$4.5</strong> × (Volumetric Weight or Gross Weight — whichever is greater) + <strong>(Tariff − 4.5)</strong> × Gross Weight + <strong>$20</strong> Admin Fee.</li>
            <li>Minimum weight for a separate shipment is <strong>30 kg</strong>.</li>
            <li>The results are approximate.</li>`;
        } else {
            els.footerNotes.innerHTML = `
            <li>Container rate calculation is available <strong>only for auto parts</strong>. For other cargo types, please contact the manager on WhatsApp. </li>
            <li>Container calculation depends on the <strong>Total Cargo Density</strong> (kg/m³).</li>
            <li>Density < 167 kg/m³: calculated as <strong>$550</strong> per 1 CBM (cubic meter).</li>
            <li>Density > 167 kg/m³: rate per kg of weight ($3.5, $3.1, $2.6). For $2.2 and $2.0 rates, the weight must exceed <strong>2000 kg</strong>.</li>
            <li>The results are approximate.</li>`;
        }
    }

    // === CALCULATIONS ===

    function sanitize(n){
      const v = Number(n);
      return isFinite(v) && v >= 0 ? v : 0;
    }

    function formatUSD(v) {
        return isFinite(v) ? `$ ${v.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}` : "—";
    }

    function getAggregatedData() {
        let totalW = 0;
        let totalVol = 0; // m3
        let totalVolW = 0; // kg for express
        
        const rows = els.boxesContainer.querySelectorAll('.box-row');
        rows.forEach(row => {
            const w = sanitize(row.querySelector('.b-w').value);
            totalW += w;

            // Logic to get row volume
            const check = row.querySelector('.vol-check');
            const volInp = row.querySelector('.b-vol');
            
            let rowM3 = 0;

            if (check.checked) {
                // Manual mode: take figure from volume input
                rowM3 = sanitize(volInp.value);
            } else {
                // Auto mode: calculate from dimensions (for accuracy, not from rounded field)
                const l = sanitize(row.querySelector('.b-len').value);
                const wd= sanitize(row.querySelector('.b-wid').value);
                const h = sanitize(row.querySelector('.b-hei').value);
                rowM3 = (l * wd * h) / 1000000;
            }

            if(rowM3 > 0) {
                totalVol += rowM3;
                // For Express: 1 CBM = 166.666 kg (or Vol / 0.006)
                // Formula (cm * cm * cm) / 6000 is equivalent to (m3 * 1000000) / 6000 = m3 * 166.6666
                totalVolW += rowM3 * (1000000 / DIM_DIVISOR);
            }
        });
        
        return { totalW, totalVol, totalVolW, count: rows.length };
    }

    function getContainerPrice(weight, cbm) {
        if (cbm <= 0.0001) return { total: 0, rateText: "—", density: 0, condition: "Enter dimensions or volume" };

        const density = weight / cbm;
        let rateVal = 0;
        let total = 0;
        let rateText = "";
        let condition = "";

        if (density < 167) {
            rateVal = 550; 
            total = cbm * rateVal;
            rateText = "$ 550.00 / CBM";
            condition = "Volumetric Cargo (< 167 kg/m³)";
        } else {
            if (density <= 200) {
                rateVal = 3.5; condition = "Density 167–200";
            } else if (density <= 300) {
                rateVal = 3.1; condition = "Density 201–300";
            } else if (density <= 400) {
                rateVal = 2.6; condition = "Density 301–400";
            } else if (density <= 500) {
                if (weight > 2000) { rateVal = 2.2; condition = "Density 401–500 (> 2t)"; }
                else { rateVal = 2.6; condition = "Density 401–500 (weight < 2t → 2.6)"; }
            } else {
                if (weight > 2000) { rateVal = 2.0; condition = "Density 501+ (> 2t)"; }
                else { rateVal = 2.6; condition = "Density 501+ (weight < 2t → 2.6)"; }
            }
            rateText = `$ ${rateVal.toFixed(2)} / kg`;
            total = weight * rateVal;
        }
        return { total, rateText, density, condition };
    }

    function recalc(){
      const data = getAggregatedData();
      const W = data.totalW;
      
      els.outQty.textContent = data.count;
      els.outPhysical.textContent = W > 0 ? `${W.toFixed(2)} kg` : "—";
      els.outCBM.textContent = data.totalVol > 0 ? `${data.totalVol.toFixed(3)} m³` : "—";
      
      let finalTotal = 0;
      let isValid = false;

      // === EXPRESS ===
      if (MODE === 'express') {
        els.outVolWeight.textContent = data.totalVolW > 0 ? `${data.totalVolW.toFixed(2)} kg` : "—";
        
        const rate = Number(els.item.options[els.item.selectedIndex]?.dataset?.rate || 0);
        const chargeable = Math.max(W, data.totalVolW);
        
        const freight = EX_BASE * chargeable;
        const tariffPart = Math.max(rate - EX_BASE, 0) * W; 
        finalTotal = freight + tariffPart + EX_ADMIN;
        
        els.outChargeable.textContent = chargeable > 0 ? `${chargeable.toFixed(2)} kg` : "—";
        els.outRate.textContent = rate ? `$ ${rate.toFixed(2)} / kg` : "—";
        els.outFreight.textContent = formatUSD(freight);
        els.residualLabel.textContent = `Residual Tariff ($${Math.max(rate - EX_BASE, 0).toFixed(2)}) × Gross Weight`;
        els.outTariffPart.textContent = formatUSD(tariffPart);

        if (W>0 && W < EX_MIN_W) {
            const soloFreight = EX_BASE * Math.max(data.totalVolW, EX_MIN_W);
            const soloTariff  = Math.max(rate - EX_BASE, 0) * Math.max(W, EX_MIN_W);
            const soloTotal   = soloFreight + soloTariff + EX_ADMIN;
            els.minNote.style.display = 'block';
            els.minNote.innerHTML = `Total weight < ${EX_MIN_W} kg. Minimum charge is applied for a separate shipment.<br>Approximate: <strong>${formatUSD(soloTotal)}</strong>`;
        } else {
            els.minNote.style.display = 'none';
        }
        isValid = (rate > 0 && W > 0 && isFinite(finalTotal));
      } 
      
      // === CONTAINER ===
      else {
        const res = getContainerPrice(W, data.totalVol);
        finalTotal = res.total;
        
        els.outDensity.textContent = (res.density > 0) ? `${res.density.toFixed(1)} kg/m³` : "—";
        els.outContainerRate.textContent = res.rateText;
        els.outCondition.textContent = res.condition;
        
        els.minNote.style.display = 'none';
        isValid = (W > 0 && data.totalVol > 0 && isFinite(finalTotal));
      }

      els.outTotal.textContent = formatUSD(isValid ? finalTotal : NaN);
      if (isValid) {
        els.outTotal.classList.add('highlight');
        setTimeout(() => els.outTotal.classList.remove('highlight'), 300);
      }

      updateButtons(isValid, finalTotal, data);
    }

    function updateButtons(isValid, total, data) {
        let msg = "";
        const dimStr = `${data.count} piece(s), total volume ${data.totalVol.toFixed(3)} m³`;
        
        if (MODE === 'express') {
            const label = els.item.options[els.item.selectedIndex]?.textContent || '';
            msg = `Hello! Express. Product: ${label}. Weight: ${data.totalW} kg. ${dimStr}. Calculator: $${total.toFixed(2)}.`;
        } else {
            msg = `Hello! Container. Weight: ${data.totalW} kg. ${dimStr}. Calculator: $${total.toFixed(2)}.`;
        }
        els.waBtn.href = `https://wa.me/971509543811?text=${encodeURIComponent(msg)}`;

        const disabled = !isValid;
        els.waBtn.style.pointerEvents = disabled ? 'none' : 'auto';
        els.waBtn.style.opacity = disabled ? .6 : 1;
        els.copyBtn.disabled = disabled;
        els.copyBtn.style.opacity = disabled ? .6 : 1;
    }

    function copyBreakdown(){
      const totalText = els.outTotal.textContent;
      const data = getAggregatedData();
      let text = `Al Daqiq Cargo (${MODE === 'express' ? 'Express' : 'Container'})\n`;
      text += `Pieces: ${data.count}\n`;
      text += `Weight: ${data.totalW.toFixed(2)} kg\n`;
      text += `Volume: ${data.totalVol.toFixed(3)} m³\n`;
      
      if(MODE === 'express'){
          text += `Product: ${els.item.options[els.item.selectedIndex].textContent}\n`;
      } else {
          text += `Density: ${els.outDensity.textContent}\n`;
          text += `Rate: ${els.outContainerRate.textContent}\n`;
      }
      text += `TOTAL: ${totalText}`;
      
      navigator.clipboard.writeText(text).then(()=>{
        els.copyBtn.textContent = 'Copied!';
        setTimeout(()=> els.copyBtn.textContent = 'Copy Calculation', 1400);
      });
    }

    function resetForm(){
      els.item.selectedIndex = 0;
      els.boxCount.value = 1;
      updateBoxRows();
      // Clear and reset the first row
      const firstRow = els.boxesContainer.firstElementChild;
      if(firstRow) {
          firstRow.querySelectorAll('input').forEach(inp => {
              inp.value = '';
              inp.disabled = false;
          });
          firstRow.querySelector('.b-vol').disabled = true; // reset volume to disabled
          firstRow.querySelector('.vol-check').checked = false;
      }
      recalc();
    }

    // Event Listeners
    els.tabs.forEach(btn => btn.addEventListener('click', e => switchMode(e.target.dataset.mode)));
    els.item.addEventListener('change', recalc);
    els.boxCount.addEventListener('change', updateBoxRows);
    els.boxCount.addEventListener('keyup', updateBoxRows); // for instant reaction
    els.copyBtn.addEventListener('click', copyBreakdown);
    els.resetBtn.addEventListener('click', resetForm);
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Start
    initSelect();
    updateBoxRows(); // creates the first row
    switchMode('express');
  </script>
</body>
</html>